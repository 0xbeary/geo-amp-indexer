[supervisord]
nodaemon=true
user=root
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid

# =============================================================================
# PostgreSQL — embedded metadata database (ephemeral, recreated on deploy)
# =============================================================================
[program:postgres]
command=/usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/data -c listen_addresses=127.0.0.1 -c port=5432
user=postgres
autostart=true
autorestart=true
priority=1
startsecs=5
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# =============================================================================
# AMP Controller — manages dataset scheduling
# =============================================================================
[program:amp-controller]
command=ampd controller
directory=/app/amp
autostart=true
autorestart=true
priority=10
startsecs=5
environment=AMP_CONFIG="/app/amp/amp.config.toml"
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# =============================================================================
# AMP Server — JSON Lines HTTP API on :1603
# =============================================================================
[program:amp-server]
command=ampd server
directory=/app/amp
autostart=true
autorestart=true
priority=11
startsecs=5
environment=AMP_CONFIG="/app/amp/amp.config.toml"
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# =============================================================================
# AMP Worker — executes indexing tasks
# =============================================================================
[program:amp-worker]
command=ampd worker --node-id worker_1
directory=/app/amp
autostart=true
autorestart=true
priority=12
startsecs=5
environment=AMP_CONFIG="/app/amp/amp.config.toml"
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0

# =============================================================================
# HTTP API — public interface for remote sinks (:3000 / $PORT)
# =============================================================================
[program:http-api]
command=node dist/server.js
directory=/app/api
autostart=true
autorestart=true
priority=20
startsecs=10
startretries=20
environment=
    AMP_ENDPOINT="http://127.0.0.1:1603",
    PORT="%(ENV_API_PORT)s",
    CORS_ORIGINS="%(ENV_CORS_ORIGINS)s"
stdout_logfile=/dev/fd/1
stdout_logfile_maxbytes=0
stderr_logfile=/dev/fd/2
stderr_logfile_maxbytes=0
